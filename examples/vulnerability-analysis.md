# AI-Assisted Vulnerability Analysis

This guide demonstrates how to use local AI for cybersecurity vulnerability analysis.

## Use Case: CVE Analysis and Remediation Planning

### Scenario
You've discovered a critical CVE affecting your infrastructure and need to quickly understand the impact, attack vectors, and remediation steps.

### Traditional Approach (Manual)
1. Search NVD database
2. Read CVE description
3. Research affected versions
4. Find vendor advisories
5. Determine exploitability
6. Plan remediation
**Time: 30-60 minutes**

### AI-Enhanced Approach
1. Query local AI with CVE number
2. Get instant comprehensive analysis
3. Review and validate
**Time: 5-10 minutes**

---

## Example Workflow

### Step 1: Query AI for CVE Analysis

**Prompt:**
```
Analyze CVE-2025-1234 and provide:

1. **Vulnerability Summary**
   - Type of vulnerability
   - Affected components/software
   - Severity rating and justification

2. **Attack Vector Analysis**
   - How can this be exploited?
   - Prerequisites for exploitation
   - Complexity (low/medium/high)

3. **Impact Assessment**
   - Confidentiality impact
   - Integrity impact
   - Availability impact
   - Potential for lateral movement

4. **Affected Versions**
   - All vulnerable versions
   - First patched version

5. **Detection**
   - Indicators of Compromise (IOCs)
   - Log signatures
   - Network signatures

6. **Mitigation Steps** (prioritized)
   - Immediate workarounds
   - Compensating controls
   - Permanent fix (patch/upgrade)

7. **References**
   - Vendor advisories
   - Proof of concept availability
   - Related CVEs

Format as a security advisory suitable for executive and technical audiences.
```

### Step 2: AI Response Example

```markdown
# CVE-2025-1234 Security Advisory

## Executive Summary
**CRITICAL** - Remote Code Execution vulnerability in Apache Struts 2.x
allows unauthenticated attackers to execute arbitrary code via crafted OGNL
expressions. Active exploitation observed in the wild. Immediate patching
required.

## Vulnerability Details

### Classification
- **Type:** Remote Code Execution (RCE)
- **Vector:** Network
- **Authentication:** None required
- **CVSS Score:** 10.0 (CRITICAL)
  - AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H

### Affected Components
- Apache Struts 2.0.0 through 2.5.30
- Applications using the REST plugin
- Java web applications with Struts framework

### Attack Vector
Attackers exploit improper input validation in the OGNL expression parser
by sending specially crafted HTTP requests with malicious expressions in
parameters. No authentication required.

**Example malicious request:**
```
POST /app/action.action
Content-Type: application/x-www-form-urlencoded

param=%{(#_='multipart/form-data').
(#[email protected]@DEFAULT_MEMBER_ACCESS).
(#cmd='whoami')...
```

### Prerequisites for Exploitation
1. Publicly accessible Struts application
2. REST plugin enabled (default in many deployments)
3. Internet connectivity from target

**Exploitation Complexity:** LOW - Public exploits available

## Impact Assessment

### Confidentiality: **HIGH**
- Access to all application data
- Potential database credential exposure
- Source code disclosure

### Integrity: **HIGH**
- Arbitrary file modification
- Application logic tampering
- Backdoor installation

### Availability: **HIGH**
- System shutdown/reboot
- Denial of service
- Ransomware deployment

### Lateral Movement Potential: **HIGH**
- Server compromise enables:
  - Network reconnaissance
  - Credential harvesting
  - Pivot to internal systems
  - Cloud metadata service access (if AWS/Azure)

## Affected Versions & Patch Status

### Vulnerable Versions
- Apache Struts 2.0.0 - 2.5.30 (all minor versions)
- Apache Struts 2.6.0 - 2.6.2

### Patched Versions
- ✅ Apache Struts 2.5.31+ (recommended)
- ✅ Apache Struts 2.6.3+

### End-of-Life Versions
- ⚠️ Struts 1.x (no longer supported, migrate to 2.5.31+)

## Detection

### Network Signatures (Snort/Suricata)
```
alert http $EXTERNAL_NET any -> $HOME_NET any (
  msg:"CVE-2025-1234 Apache Struts OGNL Injection Attempt";
  flow:to_server,established;
  content:"#_=|27|multipart/form-data|27|"; nocase;
  content:"@ognl.OgnlContext"; nocase;
  classtype:web-application-attack;
  sid:1000001; rev:1;
)
```

### Log Indicators
```
# Application logs
ERROR org.apache.struts2.dispatcher - Error parsing OGNL
Exception: ognl.OgnlException

# Web server access logs (suspicious patterns)
POST /app/*.action - "%{" in parameters
```

### Indicators of Compromise (IOCs)
- Unexpected Java processes spawned by web server
- Outbound connections to suspicious IPs
- New files in web directories (webshells)
- Scheduled tasks/cron jobs created
- Modified .class files in deployment

### YARA Rule
```yara
rule CVE_2025_1234_Exploitation_Attempt {
    meta:
        description = "Detects CVE-2025-1234 exploitation patterns"
        date = "2025-01-30"
    strings:
        $ognl1 = "#_='multipart/form-data'"
        $ognl2 = "@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS"
        $ognl3 = "#context['com.opensymphony.xwork2.dispatcher.HttpServletResponse']"
    condition:
        any of ($ognl*)
}
```

## Remediation Plan

### Priority 1: IMMEDIATE (0-24 hours)

#### Option A: Apply Patch (Recommended)
```bash
# Backup current deployment
tar -czf struts-backup-$(date +%Y%m%d).tar.gz /path/to/webapp

# Download patched version
wget https://dlcdn.apache.org/struts/2.5.31/struts-2.5.31-all.zip

# Update libraries
cp struts-2.5.31/lib/*.jar /path/to/webapp/WEB-INF/lib/

# Restart application
systemctl restart tomcat

# Verify version
curl http://localhost:8080/app | grep "Struts 2.5.31"
```

#### Option B: Compensating Controls (If patching delayed)
```
# 1. WAF rule to block OGNL patterns
# ModSecurity rule:
SecRule REQUEST_BODY|ARGS "@rx (?:#_=|@ognl\\.)" \
    "id:1000001,phase:2,deny,status:403,msg:'CVE-2025-1234 Block'"

# 2. Network segmentation
# Move application behind VPN/bastion host

# 3. Disable REST plugin
# Edit web.xml or struts.xml:
<constant name="struts.rest.handlerOverride.json" value="false" />
```

#### Option C: Emergency Mitigation
```bash
# If immediate patch impossible, take offline temporarily
systemctl stop tomcat

# Deploy static "maintenance mode" page
# Assess criticality vs. risk
```

### Priority 2: SHORT-TERM (24-72 hours)

1. **Audit Logs for Exploitation Attempts**
   ```bash
   # Check access logs
   grep -i "ognl\|%{" /var/log/apache2/access.log

   # Check for created files
   find /var/www -type f -mtime -7 -name "*.jsp"
   ```

2. **Implement Intrusion Detection**
   - Deploy Snort/Suricata with CVE signatures
   - Enable ModSecurity WAF rules
   - Configure SIEM alerting

3. **Harden Struts Configuration**
   ```xml
   <!-- struts.xml -->
   <constant name="struts.devMode" value="false" />
   <constant name="struts.action.excludePattern" value=".*\\..*" />
   ```

### Priority 3: MEDIUM-TERM (1-2 weeks)

1. **Security Code Review**
   - Audit custom Struts actions for similar issues
   - Review OGNL expression usage
   - Implement input validation

2. **Penetration Testing**
   - Validate patch effectiveness
   - Test for bypass techniques
   - Verify detection rules

3. **Incident Response Plan Update**
   - Document lessons learned
   - Update runbooks for RCE incidents
   - Train SOC team on detection

### Priority 4: LONG-TERM (1-3 months)

1. **Vulnerability Management**
   - Implement automated CVE scanning
   - Subscribe to Apache security mailing list
   - Establish patch SLA (Critical: 7 days)

2. **Security Architecture Review**
   - Evaluate migration to modern framework (Spring Boot)
   - Implement defense in depth
   - Reduce attack surface

3. **Security Monitoring**
   - Continuous monitoring for new CVEs
   - Automated patch testing in staging
   - Regular penetration testing

## Verification & Testing

### Patch Verification
```bash
# 1. Check version
java -cp /path/to/webapp/WEB-INF/lib/struts2-core-*.jar \
  org.apache.struts2.StrutsConstants

# Expected output: 2.5.31 or higher

# 2. Test exploitation (in controlled environment)
curl -X POST http://localhost:8080/test/action.action \
  --data 'name=%{1+1}'

# Expected: Input rejected or sanitized

# 3. Verify WAF rules
curl -X POST http://localhost:8080/test/action.action \
  --data 'name=%{@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS}'

# Expected: HTTP 403 Forbidden
```

### Regression Testing
```bash
# Ensure application functionality intact
./run-integration-tests.sh

# Check for performance degradation
ab -n 1000 -c 10 http://localhost:8080/app/index.action
```

## References & Resources

### Vendor Advisory
- [Apache Struts Security Bulletin S2-XXX](https://struts.apache.org/security/)

### CVE Details
- [NVD CVE-2025-1234](https://nvd.nist.gov/vuln/detail/CVE-2025-1234)
- [MITRE CVE-2025-1234](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2025-1234)

### Exploit Information
- ⚠️ Public PoC available on GitHub (do not use maliciously)
- Metasploit module: `exploit/multi/http/struts2_rce_cve_2025_1234`

### Related CVEs
- CVE-2017-5638 (similar OGNL injection)
- CVE-2018-11776 (Struts REST plugin RCE)

### Recommended Reading
- [OWASP Top 10: Injection](https://owasp.org/Top10/A03_2021-Injection/)
- [Apache Struts Security Best Practices](https://struts.apache.org/security/)

---

## Communication Templates

### Executive Summary Email

```
Subject: CRITICAL Security Alert - Apache Struts Vulnerability (CVE-2025-1234)

Priority: HIGH
Severity: CRITICAL (CVSS 10.0)

SUMMARY:
A critical remote code execution vulnerability affects our Apache Struts
applications. Attackers can gain full system access without authentication.
Public exploits are available, and active exploitation is observed globally.

BUSINESS IMPACT:
- Complete system compromise possible
- Data breach risk (customer data, credentials)
- Service disruption potential
- Regulatory/compliance implications

IMMEDIATE ACTIONS REQUIRED:
1. Emergency patch deployment scheduled: [DATE/TIME]
2. Enhanced monitoring enabled
3. Incident response team on standby

TIMELINE:
- Patch deployment: Within 24 hours
- Verification complete: 48 hours
- Post-incident review: 1 week

POC: [Security Team Lead]
Questions: Contact SOC at [email/phone]
```

### Technical Team Alert

```
TO: DevOps, Application Teams
FROM: Security Operations
RE: CRITICAL - CVE-2025-1234 Patching Required

VULNERABILITY: Apache Struts RCE
AFFECTED SYSTEMS: [List of applications]

ACTION REQUIRED:
1. Schedule emergency maintenance window
2. Apply patch (Struts 2.5.31+)
3. Restart applications
4. Verify patch effectiveness

DEADLINE: [DATE/TIME]

SUPPORT: Security team available 24/7 for assistance

[Technical details and runbook attached]
```

---

## Lessons Learned

### What Went Well
- Rapid detection and analysis using AI
- Clear communication to stakeholders
- Coordinated response across teams

### Areas for Improvement
- Patch deployment took longer than target SLA
- Detection rules should have been pre-positioned
- Need automated testing for critical patches

### Action Items
- [ ] Implement automated vulnerability scanning
- [ ] Pre-deploy WAF rules for common attack patterns
- [ ] Establish patch testing automation
- [ ] Create framework-specific incident playbooks

---

**Document Version:** 1.0
**Last Updated:** 2025-01-30
**Next Review:** 2025-02-30
**Owner:** Security Operations Team
```

### Step 3: Validate and Enhance

Review the AI-generated analysis and:
1. ✅ Verify CVE details against NVD
2. ✅ Cross-reference with vendor advisories
3. ✅ Test detection signatures in lab environment
4. ✅ Validate remediation steps
5. ✅ Add organization-specific context

### Step 4: Implement and Document

1. Execute remediation plan
2. Update incident response documentation
3. Share lessons learned with team
4. Archive analysis for compliance

---

## Benefits of AI-Assisted Analysis

### Speed
- **Manual:** 30-60 minutes per CVE
- **AI-Assisted:** 5-10 minutes per CVE
- **Efficiency Gain:** 80-85%

### Consistency
- Standardized analysis format
- Comprehensive coverage of all aspects
- Reduced human error

### Quality
- Detailed detection signatures
- Prioritized remediation steps
- Communication templates

### Scalability
- Analyze multiple CVEs simultaneously
- Handle vulnerability backlogs
- Enable proactive research

---

## Advanced Techniques

### Multi-Model Comparison

Use big-AGI's **Beam Mode** to compare responses from multiple models:
- Llama 3.1 70B (comprehensive analysis)
- CodeLlama 13B (exploit code analysis)
- Mistral 7B (quick triage)

### RAG Enhancement

Enhance analysis with your organization's data:
- Previous incident reports
- Internal security policies
- Asset inventory
- Compliance requirements

### Automated Workflows

Integrate AI analysis into security pipelines:
```bash
# Automated CVE analysis pipeline
./scripts/ai-vuln-analyzer.py --cve CVE-2025-1234 \
  --format markdown \
  --output reports/CVE-2025-1234-analysis.md \
  --notify security-team@company.com
```

---

## Best Practices

1. **Always Validate:** AI provides starting point, not final answer
2. **Cross-Reference:** Verify against multiple sources
3. **Add Context:** Include organization-specific details
4. **Document:** Save analyses for future reference
5. **Iterate:** Refine prompts based on results
6. **Privacy:** Never paste actual credentials or sensitive data

---

## Related Examples

- [Malware Analysis with AI](malware-analysis.md)
- [Log Analysis and Threat Hunting](log-analysis.md)
- [Security Code Review](code-review.md)
